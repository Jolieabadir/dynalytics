"""
Simple test to verify backend components work independently.

Run with: python test_backend.py
"""
from pathlib import Path
from datetime import datetime

# Add src to path
import sys
sys.path.insert(0, str(Path(__file__).parent / 'src'))

from labeling.models import Video, Move, FrameTag, MOVE_TYPES, MOVE_TYPE_QUESTIONS
from labeling.database import Database


def test_models():
‹    """Test that models work correctly."""
    print("Testing models...")
    
    # Test Video
    video = Video(
        id=1,
        filename="test.mov",
        path="videos/test.mov",
        csv_path="data/test.csv",
        fps=30.0,
        total_frames=900,
        duration_ms=30000.0,
        uploaded_at=datetime.now()
    )
    
    video_dict = video.to_dict()
    assert video_dict['filename'] == "test.mov"
    assert video_dict['fps'] == 30.0
    print("✓ Video model works")
    
    # Test Move
    move = Move(
        id=1,
        video_id=1,
        frame_start=150,
        frame_end=200,
        timestamp_start_ms=5000.0,
        timestamp_end_ms=6666.7,
        move_type='dyno',
        form_quality=4,
        effort_level=7,
        contextual_data={'catching_hand': 'right_hand', 'push_foot': 'left_foot'},
        tags=['tweaky_feeling'],
        description="Test move",
        labeled_at=datetime.now()
    )
    
    assert move.duration_seconds() == 1.6667
    assert move.frame_count() == 51
    print("✓ Move model works")
    
    # Test FrameTag
    tag = FrameTag(
        id=1,
        move_id=1,
        frame_number=155,
        timestamp_ms=5166.7,
        tag_type='pain',
        level=6,
        locations=['left_knee'],
        note="Sharp pain",
        tagged_at=datetime.now()
    )
    
    assert tag.is_sensation_tag() == True
    print("✓ FrameTag model works")
    
    # Test configs
    assert 'dyno' in MOVE_TYPES
    assert 'catching_hand' in MOVE_TYPE_QUESTIONS['dyno']
    print("✓ Move configurations loaded")
    
    print("\n✅ All model tests passed!\n")


def test_database():
    """Test that database operations work."""
    print("Testing database...")
    
    # Use test database
    db = Database('data/test_labels.db')
    db.init()
    print("✓ Database initialized")
    
    # Test Video CRUD
    video = Video(
        filename="test.mov",
        path="videos/test.mov",
        csv_path="data/test.csv",
        fps=30.0,
        total_frames=900,
        duration_ms=30000.0,
        uploaded_at=datetime.now()
    )
    
    video_id = db.create_video(video)
    assert video_id > 0
    print(f"✓ Created video with ID: {video_id}")
    
    retrieved_video = db.get_video(video_id)
    assert retrieved_video.filename == "test.mov"
    print("✓ Retrieved video")
    
    all_videos = db.get_all_videos()
    assert len(all_videos) >= 1
    print(f"✓ Listed {len(all_videos)} video(s)")
    
    # Test Move CRUD
    move = Move(
        video_id=video_id,
        frame_start=150,
        frame_end=200,
        timestamp_start_ms=5000.0,
        timestamp_end_ms=6666.7,
        move_type='dyno',
        form_quality=4,
        effort_level=7,
        contextual_data={'catching_hand': 'right_hand'},
        tags=['tweaky_feeling'],
        description="Test move",
        labeled_at=datetime.now()
    )
    
    move_id = db.create_move(move)
    assert move_id > 0
    print(f"✓ Created move with ID: {move_id}")
    
    retrieved_move = db.get_move(move_id)
    assert retrieved_move.move_type == 'dyno'
    assert retrieved_move.contextual_data['catching_hand'] == 'right_hand'
    print("✓ Retrieved move with contextual data")
    
    moves = db.get_moves_for_video(video_id)
    assert len(moves) == 1
    print(f"✓ Listed {len(moves)} move(s) for video")
    
    # Test update
    move.description = "Updated description"
    move.id = move_id
    db.update_move(move)
    updated_move = db.get_move(move_id)
    assert updated_move.description == "Updated description"
    print("✓ Updated move")
    
    # Test FrameTag CRUD
    tag = FrameTag(
        move_id=move_id,
        frame_number=155,
        timestamp_ms=5166.7,
        tag_type='pain',
        level=6,
        locations=['left_knee'],
        note="Sharp pain",
        tagged_at=datetime.now()
    )
    
    tag_id = db.create_frame_tag(tag)
    assert tag_id > 0
    print(f"✓ Created frame tag with ID: {tag_id}")
    
    retrieved_tag = db.get_frame_tag(tag_id)
    assert retrieved_tag.tag_type == 'pain'
    assert retrieved_tag.level == 6
    assert 'left_knee' in retrieved_tag.locations
    print("✓ Retrieved frame tag with locations")
    
    tags = db.get_frame_tags_for_move(move_id)
    assert len(tags) == 1
    print(f"✓ Listed {len(tags)} tag(s) for move")
    
    # Test delete
    db.delete_frame_tag(tag_id)
    assert db.get_frame_tag(tag_id) is None
    print("✓ Deleted frame tag")
    
    db.delete_move(move_id)
    assert db.get_move(move_id) is None
    print("✓ Deleted move (cascade)")
    
    print("\n✅ All database tests passed!\n")
    
    # Clean up test database
    Path('data/test_labels.db').unlink(missing_ok=True)
    print("✓ Cleaned up test database")


if __name__ == '__main__':
    print("=" * 60)
    print("BACKEND COMPONENT TESTS")
    print("=" * 60)
    print()
    
    test_models()
    test_database()
    
    print("=" * 60)
    print("✅ ALL TESTS PASSED!")
    print("=" * 60)
    print("\nBackend is ready. You can now:")
    print("1. Run the API: uvicorn src.web.api:app --reload")
    print("2. Visit: http://localhost:8000/docs for API documentation")
    print()
